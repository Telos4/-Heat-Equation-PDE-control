%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[
12pt, % Default font size is 10pt, can alternatively be 11pt or 12pt
a4paper, % Alternatively letterpaper for US letter
onecolumn, % Alternatively twocolumn
portrait % Alternatively landscape
]{article}

\input{structure.tex} % Input the file specifying the document layout and structure

%----------------------------------------------------------------------------------------
%	ARTICLE INFORMATION
%----------------------------------------------------------------------------------------

\articletitle{Notes on the simulation of the heat equation in Firedrake} 

\datenotesstarted{October 10, 2017}
\docdate{\datenotesstarted; rev. \today}

\docauthor{Simon Pirkelmann}

%----------------------------------------------------------------------------------------

\begin{document}

\pagestyle{myheadings} % Use custom headers
\markright{\doctitle} % Place the article information into the header

%----------------------------------------------------------------------------------------
%	PRINT ARTICLE INFORMATION
%----------------------------------------------------------------------------------------

\thispagestyle{plain} % Plain formatting on the first page

\printtitle % Print the title

%----------------------------------------------------------------------------------------
%	ARTICLE NOTES
%----------------------------------------------------------------------------------------
\section{Setting}
Consider the following equation
\begin{equation}
y_t -  \alpha \Delta y = 0 \text{ on } Q := \Omega \times [0,T]
\label{eq:pde}
\end{equation}
where $y : Q \rightarrow \mathbb{R}$ is the temperature, $\alpha \in \mathbb{R}$ is the diffusion coefficient. We use the shorthand $y_t = \frac{\partial y}{\partial t}$ to denote the time derivative.
 
As a domain we consider the unit square. The boundary is partitioned in an isolating boundary $\Gamma_i$ and a control boundary $\Gamma_c$.
On the control part of the boundary heating/cooling is applied which is described by a Dirichlet condition
\begin{equation}
y = u \text{ on } \Gamma_c.
\end{equation}
On the isolating part we have
\begin{equation}
- \frac{\partial y}{\partial n} = 0 \text{ on } \Gamma_i
\end{equation}
where $\frac{\partial y}{\partial n}$ is the derivative of $y$ in normal direction.

\begin{center}
\begin{tikzpicture}
\draw[->] (-0.25,0) -- (3.25,0) node[anchor=north] {};
\draw[->] (0,-0.25) -- (0,3.25) {};

\draw [blue] plot coordinates {(0,0) (0,3) (3,3) (3,0)};

\draw [red] plot coordinates { (0,0) (3,0)};

\draw	(-0.2,-0.25) node {$0$}
		(-0.2,3) node {$1$}
		(3,-0.25) node {$1$}	
		(1.5, 1.5) node {\large{$\Omega$}}
		(1.5, -0.3) node[red] {\large{$\Gamma_c$}}
		(1.5, 3.28) node[blue] {\large{$\Gamma_i$}}
		;
\end{tikzpicture}
\end{center}
For the moment we assume that $u : [0, T] \rightarrow \mathbb{R}$ and $y_{out} : [0,T] \rightarrow \mathbb{R}$ are constant on $\Gamma_c$ and $\Gamma_{out}$ respectively, i.e. that they are independent of space.

TODO: how to get to this boundary condition!

For simplicity we use a single Robin type boundary condition instead
\begin{equation}
- \beta \frac{\partial y}{\partial n} = \gamma (y - z) \text{ on } \Gamma.
\label{eq:robin-bc}
\end{equation}
By choosing 
$\gamma := \begin{cases}
\gamma_{out} &\text{ on } \Gamma_i \\ 
\gamma_c &\text{ on } \Gamma_c \\
\end{cases}
$
and
$z := \begin{cases}
y_{out} &\text{ on } \Gamma_{out} \\ 
u &\text{ on } \Gamma_c \\
\end{cases}
$
we can approximate both types of boundary conditions in a uniform way. 
This will also allow us to extend the setting more easily in the future.
\section{Numerical simulation of the heat equation}
We simulate the equation using the finite element method.
\subsection{Weak form}
For the weak form we first discretize in time by picking a sampling rate $h > 0$. We define $y_k := y(\cdot, t_0 + h k)$, $y_{out,k} := y_{out}(\cdot, t_0 + h k) $, $u_k := u(t_0 + h k)$, $z_k := z(t_0 + h k)$ for $k \in \{0, 1, \hdots, N\}$. \\
The initial value $y_0$ is given. To compute the next state $y_{k+1}$ for each $k \in \{0, 1, \hdots, N-1\}$  we replace $y_t$ in equation \eqref{eq:pde} by $\frac{y_{k+1} - y_k}{h}$ and $y$ by $y_{k+1}$ using backward Euler. Multiplying with a test function $v$ and integrating over the domain $\Omega$ yields
\begin{equation}
\int_{\Omega} \frac{y_{k+1} - y_k}{h} v \; dx - \alpha \int_{\Omega} \Delta y_{k+1} v \; dx = 0 \text{ for } k \in \{0, 1, \hdots, N-1\}.
\end{equation}
Using partial integration on the second integral we get
\begin{equation}
\int_{\Omega} \frac{y_{k+1} - y_k}{h} v \; dx - \alpha \int_{\Gamma}  \frac{\partial y_{k+1}}{\partial n} v \; ds + \alpha \int_{\Omega} \nabla y_{k+1} \cdot \nabla v \; dx = 0
\end{equation}
Substituting the boundary condition \eqref{eq:robin-bc} we obtain
\begin{equation}
\int_{\Omega} \frac{y_{k+1} - y_k}{h} v \; dx + \alpha \int_{\Gamma} \frac{ \gamma}{\beta}  (y_{k+1} - z_k) v \; ds + \alpha \int_{\Omega} \nabla y_{k+1} \cdot \nabla v \; dx = 0
\end{equation}
TODO: Strictly speaking, for backward Euler we may actually have to use $z_{k+1}$ here instead. Think about this!\\
Substituting the definition of $z_k$ and $\gamma$ on the different parts $\Gamma_{out}$ and $\Gamma_c$ of the boundary we get
\begin{equation}
\int_{\Omega} \frac{y_{k+1} - y_k}{h} v \; dx +  \alpha \int_{\Gamma_c} \frac{\gamma_c}{\beta}  (y_{k+1} - u_k) v \; ds  +  \alpha\int_{\Gamma_{out}} \frac{ \gamma_{out}}{\beta}  (y_{k+1} - y_{out,k}) v \; ds + \alpha \int_{\Omega} \nabla y_{k+1} \cdot \nabla v \; dx = 0
\end{equation}

\subsection{Implementation in Firedrake}
The above variational equation is solved in Firedrake for each $k \in \{0, 1, \hdots, N-1\}$:
\begin{python}
# Definitions 
S = FunctionSpace(self.mesh, "CG", 1)
v = TestFunction(S)
y1 = Function(S)
y0 = Function(S)

h = Constant(0.001)
gamma = [0.0, 0.0, 1.0e3, 0.0] # gamma for different parts of the boundary
ac = 0.2
u = [0.0, 0.0, 25.0, 0.0]
\end{python}

\begin{python}
a = (y1 * v + h * ac * inner(grad(y1), grad(v))) * dx
for i in range(1,5):
    a += h * ac * Constant(gamma[i-1]) * y1 * v * ds(i)
\end{python}


\begin{python}
F = inner(y0, v) * dx
for i in range(1, 5):
    F += h * ac * Constant(gamma[i-1]) * Constant(u[i-1]) * v * ds(i)
\end{python}

\section{Optimal Control Problem}
Now that the simulation is running we want to implement an optimal control problem on top of it. Our goal is to solve the following problem:
\begin{align*}
\min_{y,u} J(y, u) = & \frac{1}{2}\int_{\Omega} (y(x, T) - y_{\Omega}(T,x))^2 \; dx + \frac{1}{2} \int_{0}^{T} \int_{\Omega} (y(x,t) - y_{\Omega}(t,x))^2 \; dx \; dt \\
& + \frac{\lambda}{2} \int_{0}^{T} \int_{\Gamma} (u(x,t))^2 \; ds \; dt \\
\text{s.t.} & \eqref{eq:pde}, \eqref{eq:robin-bc} \\
& \underline{u}(x,t) \leq u(x,t) \leq \overline{u}(x,t) \\
& \underline{y}(x,t) \leq y(x,t) \leq \overline{y}(x,t)
\end{align*}
While the constraints on the control can be dealt with rather straightforwardly, the state constraints present some challenges. We will use Lavrentiev regularisation to handle the state constraints. The Lavrentiev regularisation replaces the state constraint by a mixed state-control constraint. For this we introduce an additional control variable $v : \Omega \times [0, \infty) \rightarrow \mathbb{R}$ defined on the whole domain. This control variable will also be penalized in the cost functional, and so the cost functional is modified to
\begin{align*}
\min_{u,v} J(y, u, v) = & \frac{1}{2}\int_{\Omega} (y(x, T) - y_{\Omega}(T,x))^2 \; dx + \frac{1}{2} \int_{0}^{T} \int_{\Omega} (y(x,t) - y_{\Omega}(t,x))^2 \; dx \; dt \\
& \frac{\sigma}{2} \int_{0}^{T} \int_{\Omega} (v(x,t))^2 \; dx \; dt 
+ \frac{\lambda}{2} \int_{0}^{T} \int_{\Gamma} (u(x,t))^2 \; ds \; dt
\end{align*}
The state constraint is replaced by the auxiliary control constraint
%\begin{equation}

%\end{equation}
\begin{alignat*}{2}
\underline{y}(x,t) &\leq y(x,t) + \varepsilon v(x,t) &&\leq \overline{y}(x,t) \\
\Leftrightarrow \underbrace{\frac{1}{\varepsilon}(\underline{y}(x,t) - y(x,t))}_{\underline{v}(x,t)} &\leq v(x,t) &&\leq \underbrace{\frac{1}{\varepsilon}(\overline{y}(x,t) - y(x,t))}_{\overline{v}(x,t)} \\
\end{alignat*}

This kind of optimal control problem (with both a control on the boundary and a control in the domain) is considered in [Tr\"oltzsch, p.221ff]. We look at the general cost functional
\begin{align*}
\min_{y,u,v} J(y, u, v) = & \int_{\Omega} \phi(x, y(T)) \; dx + \int \int_{Q} \varphi(x, t, y, v) \; dx \; dt \\
& + \int \int_{\Sigma} \psi(x,t,y, u) \; ds \; dt \\
\end{align*}
subject to
\begin{alignat*}{2}
y_t - \alpha \Delta y + d(x,t,y,v) &= 0 && \text{ in } Q \\
\partial_n y + b(x,t,y,u) &= 0 && \text{ in } \Sigma \\
y(\cdot,0) &= y_0 && \text{ on } \Omega \\
v_a(x,t) \leq v(x,t) &\leq v_b(x,t) &&\text{ in } Q \\
u_a(x,t) \leq u(x,t) &\leq u_b(x,t) &&\text{ in } \Sigma
\end{alignat*}

In our case we have the following identities:
\begin{align*}
\phi(x,y(x,T)) & = \frac{1}{2} (y(x,T) - y_{\Omega}(x,T))^2 \\
\phi_y(x,y(x,T)) & = y(x,T) - y_{\Omega}(x,T) \\
\\
\varphi(x,t, y(x,t), v(x,t)) & = \frac{1}{2} (y(x,t) - y_{\Omega}(x,t))^2 + \frac{\sigma}{2} (v(x,t))^2 \\
\varphi_y(x,t,y(x,t), v(x,t)) &= y(x,t) - y_{\Omega}(x,t) \\
\varphi_v(x,t,y(x,t), v(x,t)) &= \sigma v(x,t) \\
\\
\psi(x,t,y(x,t), u(x,t)) &= \frac{\lambda}{2} (u(x,t))^2 \\
\psi_y(x,t,y(x,t), u(x,t)) &= 0 \\
\psi_u(x,t,y(x,t), u(x,t)) &= \lambda u(x,t) \\
\\
d(x,t, y(x,t), v(x,t)) &= 0 \\
d_y(x,t, y(x,t), v(x,t)) &= 0 \\
d_v(x,t, y(x,t), v(x,t)) &= 0 \\
\\
b(x,t, y(x,t), u(x,t)) &= \frac{\gamma(x,t)}{\beta(x,t)} (y(x,t) - z(x,t)) \\
b_y(x,t, y(x,t), u(x,t)) &= \frac{\gamma(x,t)}{\beta(x,t)} \\
b_u(x,t, y(x,t), u(x,t)) &= -\frac{\gamma(x,t)}{\beta(x,t)}
\end{align*}

\section{Derivation of the adjoint system}
We introduce the adjoint states $p_1$ and $p_2$ to remove the PDE equality constraints. The Lagrangian for the problem is given by
\begin{align*}
\mathcal{L}(y,u,v,p_1, p_2) = & J(y,u,v) - \int_{0}^{T} \int_{\Omega} (\frac{\partial y}{\partial t} - \alpha \Delta y + d(x,t,y,v)) p_1 \; dx \; dt \\ & - \int_{0}^{T} \int_{\Gamma} (\partial_n y + b(x,t,y,u)) p_2 \; dx \; dt
\end{align*}
For optimality we need
\begin{alignat*}{2}
D_y \mathcal{L}(\bar{y},\bar{u},\bar{v},p_1, p_2) y & = 0, &\text{ for all } y \text{ with } y(\cdot, 0) = 0 \\
D_u \mathcal{L}(\bar{y},\bar{u},\bar{v},p_1, p_2) (u - \bar{u}) & \geq 0, &\text{ for all } u \in U_{ad} \\
D_v \mathcal{L}(\bar{y},\bar{u},\bar{v},p_1, p_2) (v - \bar{v}) & \geq 0, &\text{ for all } v \in V_{ad} \\
\end{alignat*}
In the following we compute $D_y \mathcal{L}$, $D_u \mathcal{L}$ and $D_v \mathcal{L}$. We start with $D_y \mathcal{L}$:
\begin{align*}
 D_y \mathcal{L}(y, u,v, p_1, p_2) h = & D_y J(y,u,v) h - \int_{0}^{T} \int_{\Omega} (\frac{\partial h}{\partial t} - \alpha \Delta h + d_y(x,t,y,v) h) p_1 \; dx \; dt \\ 
& - \int_{0}^{T} \int_{\Gamma} (\partial_n h + b_y(x,t,y,u) h) p_2 \; dx \; dt,
\end{align*} 
where for $D_y J(y,u,v)$ it holds that
\begin{equation}
D_y J(y,u,v) h = \int_{\Omega} \phi_y(x,y) h(T) \; dx + \int_{0}^{T} \int_{\Omega} \varphi_y(x,t,y, v) h \; dx \; dt 
+ \int_{0}^{T} \int_{\Gamma} \psi_y(x,t,y, u) h \; ds \; dt.
\end{equation}
First we consider the term
\begin{align*}
&- \int_{0}^{T} \int_{\Omega} (\frac{\partial h}{\partial t} - \alpha \Delta h + d_y(x,t,y,v) h) p_1 \; dx \; dt \\
& = - \int_{\Omega} \int_{0}^{T} \frac{\partial h}{\partial t} p_1 \; dx \; dt + \int_{0}^{T} \int_{\Omega} \alpha \Delta h p_1 \; dx \; dt - \int_{0}^{T} \int_{\Omega} d_y(x,t,y,v) h p_1 \; dx \; dt.
\end{align*}
Using partial integration (in time) for the first term and Green's second formula (in space) for the second term we obtain
\begin{align*}
&- \int_{\Omega} \int_{0}^{T} \frac{\partial h}{\partial t} p_1 \; dx \; dt + \alpha \int_{0}^{T} \int_{\Omega}  \Delta h p_1 \; dx \; dt - \int_{0}^{T} \int_{\Omega} d_y(x,t,y,v) h p_1 \; dx \; dt\\
= &- \int_{\Omega} \left[h p_1 \right]_0^T \; dx + \int_{\Omega} \int_{0}^{T}   \frac{\partial p_1}{\partial t} h \; dx \; dt + \alpha \int_{0}^{T} \int_{\Omega} \Delta p_1 h \; dx \; dt \\ 
&+ \alpha \int_{0}^{T} \int_{\Gamma}
p_1 \frac{\partial h}{\partial n} \; ds \; dt - \alpha \int_{0}^{T} \int_{\Gamma}
\frac{\partial p_1}{\partial n} h \; ds \; dt
 - \int_{0}^{T} \int_{\Omega} d_y(x,t,y,v) p_1 h \; dx \; dt \\
= &\int_{\Omega} p_1(0) h(0) \; dx - \int_{\Omega} p_1(T) h(T) \; dx +  \int_{0}^{T} \int_{\Omega} \frac{\partial p_1}{\partial t} h \; dx \; dt + \alpha \int_{0}^{T} \int_{\Omega} \Delta p_1 h \; dx \; dt \\ 
&+ \alpha \int_{0}^{T} \int_{\Gamma}
p_1 \frac{\partial h}{\partial n} \; ds \; dt - \alpha \int_{0}^{T} \int_{\Gamma}
\frac{\partial p_1}{\partial n} h \; ds \; dt
 - \int_{0}^{T} \int_{\Omega} d_y(x,t,y,v) p_1 h \; dx \; dt \\
 \overset{h(0)=0}{=} & - \int_{\Omega} p_1(T) h(T) \; dx + \int_{\Omega} \int_{0}^{T}   \frac{\partial p_1}{\partial t} h \; dx \; dt + \alpha \int_{0}^{T} \int_{\Omega} \Delta p_1 h \; dx \; dt \\ 
&+ \alpha \int_{0}^{T} \int_{\Gamma}
p_1 \frac{\partial h}{\partial n} \; ds \; dt - \alpha \int_{0}^{T} \int_{\Gamma} \frac{\partial p_1}{\partial n} h \; ds \; dt
 - \int_{0}^{T} \int_{\Omega} d_y(x,t,y,v) p_1 h \; dx \; dt \\
\end{align*}
In the last step we used that $h(0) = 0$. This is explained in [Tr\"oltzsch, p.96] and follows from a substitution $y := y - \bar{y}$ for the state.\\
By substituting the above equation in the original equation and ordering by integration domains we obtain
\begin{align*}
D_y J(y,u,v) h = & \int_{\Omega} (\phi_y(x,y) - p_1(T)) h(T) \; dx \\
& + \int_{0}^{T} \int_{\Omega} (\frac{\partial p_1}{\partial t} + \alpha \Delta p_1 - d_y(x,t,y,v) p_1 + \varphi_y(x,t,y, v)) h \; dx \; dt  \\
& + \int_{0}^{T} \int_{\Gamma} (\alpha p_1 - p_2) \frac{\partial h}{\partial n} \; ds \; dt \\
& + \int_{0}^{T} \int_{\Gamma} (- \alpha \frac{\partial p_1}{\partial n} - b_y(x,t,y,u) p_2 + \psi_y(x,t,y, u))  h \; ds \; dt
\end{align*}
Now we make special choices of $h$, first $h \in C_0^\infty(Q)$, then with arbitrary $h(T)$, arbitrary $h|_\Sigma$  and finally with arbitrary $\frac{\partial h}{\partial n}$. From this we obtain the following adjoint equation:
\begin{equation}
\begin{alignedat}{2}
-p_{1,t} - \alpha \Delta p_1 + d_y(x,t,\bar{y}, \bar{v}) p_1 &= \varphi_y(x,t,\bar{y}, \bar{v}) &&\text{ in } Q \\
\alpha \partial_n p_1 + b_y(x,t,\bar{y}, \bar{u}) p_2 &= \psi_y(x,t,\bar{y}, \bar{u}) &&\text{ in } \Sigma \\
\alpha p_1 &= p_2 &&\text{ in } \Sigma \\
p_1(x,T) &= \phi_y(x, \bar{y}(x,T)) &&\text{ in } \Omega
\label{eq:adjoint-pde-preliminary}
\end{alignedat}
\end{equation}
By setting $p := p_1$, $p_2 = \alpha p$ we obtain:
\begin{equation}
\begin{alignedat}{2}
-p_t - \alpha \Delta p + d_y(x,t,\bar{y}, \bar{v}) p &= \varphi_y(x,t,\bar{y}, \bar{v}) &&\text{ in } Q \\
\partial_n p + b_y(x,t,\bar{y}, \bar{u}) p &= \frac{1}{\alpha}\psi_y(x,t,\bar{y}, \bar{u}) &&\text{ in } \Sigma \\
p(x,T) &= \phi_y(x, \bar{y}(x,T)) &&\text{ in } \Omega
\label{eq:adjoint-pde}
\end{alignedat}
\end{equation}
A similar result (but without the diffusion coefficient $\alpha$) can be found in [Tr\"oltzsch, p.225f].\\
Finally we also compute $D_u \mathcal{L}$ and $D_v \mathcal{L}$:
\begin{align*}
D_u \mathcal{L}(y,u,v, p) h & = D_u J(y,u,v) h - \int_{0}^{T} \int_{\Gamma} b_u(x,t,y,u) p h \; ds \; dt \\
& = \int_{0}^{T} \int_{\Gamma}  (\psi_u(x,t,y,u) -  b_u(x,t,y,u) p)  h \; ds \; dt
\end{align*}
\begin{align*}
D_v \mathcal{L}(y,u,v, p) h & = D_v J(y,u,v) h - \int_{0}^{T} \int_{\Omega} d_v(x,t,y,v) p h \; dx \; dt \\
& = \int_{0}^{T} \int_{\Omega}  (\varphi_v(x,t,y,v) -  d_v(x,t,y,v) p)  h \; dx \; dt
\end{align*}

\section{Weak form of the adjoint system}
To derive the weak form of the adjoint system \eqref{eq:adjoint-pde} we first note that the equation evolves backward in time. To get a forward equation we use the substitution $\tau := T - t$.
Define
\begin{align*}
\tilde{p}(x,\tau) &:= p(x,T-\tau) = p(x,t) \\
\tilde{y}(x,\tau) &:= y(x,T-\tau) \\
\tilde{u}(x,\tau) &:= u(x,T-\tau) \\
\tilde{v}(x,\tau) &:= v(x,T-\tau)
\end{align*}
Noting that $D_{\tau}\tilde{p}(x,\tau) = -D_t p(x,t)$, the adjoint system changes to
\begin{equation}
\begin{alignedat}{2}
\tilde{p}_{\tau} - \alpha \Delta \tilde{p} + d_y(x,T-\tau,\tilde{y}, \tilde{v}) \tilde{p} &= \varphi_y(x,T-\tau,\tilde{y}, \tilde{v}) &&\text{ in } Q \\
\partial_n \tilde{p} + b_y(x,T-\tau,\tilde{y}, \tilde{u}) \tilde{p} &= \frac{1}{\alpha}\psi_y(x,T-\tau,\tilde{y}, \tilde{u}) &&\text{ in } \Sigma \\
\tilde{p}(x,0) &= \phi_y(x, \tilde{y}(x,0)) &&\text{ in } \Omega
\label{eq:adjoint-pde-time-substitution}
\end{alignedat}
\end{equation}
Now the system can be solved again using backward Euler. Replace $\tilde{p}_\tau$ by $\frac{\tilde{p}_{k+1} - \tilde{p}_k}{h}$ and $\tilde{p}$, $\tilde{y}$, $\tilde{u}$ and $\tilde{v}$ by their discrete counterparts.  We multiply with the test function $v$ and integrate:
\begin{align*}
\int_{\Omega} \frac{\tilde{p}_{k+1} - \tilde{p}_k}{h} v \; dx - \int_{\Omega} \alpha \Delta \tilde{p}_{k+1} v \; dx + \int_{\Omega} d_y(x,T-\tau_{k}, \tilde{y}_k, \tilde{v}_k) \tilde{p}_{k+1} v \; dx = \int_{\Omega} \varphi_y(x,T-\tau_k,\tilde{y}_k, \tilde{v}_k) v \; dx
\end{align*}
Using partial integration on the second integral and inserting the boundary condition yields 
\begin{align*}
\int_{\Omega} \alpha \Delta \tilde{p}_{k+1} v \; dx & = - \int_{\Gamma} \alpha \frac{\partial \tilde{p}_{k+1}}{\partial n} v ds + \alpha \int_{\Omega}  \nabla \tilde{p}_{k+1} \nabla v \; dx \\
& = \int_{\Gamma} \alpha b_y(x,T - \tau_k, \tilde{y}_k, \tilde{u}_k) \tilde{p}_{k+1} v \; ds - \int_{\Gamma} \psi_y(x,T- \tau_k, \tilde{y}_k, \tilde{u}_k) v \; ds \\
&+ \alpha \int_{\Omega} \nabla \tilde{p}_{k+1} \nabla v \; dx
\end{align*}
We insert this in the first equation again and order by integration domain
\begin{align*}
\int_{\Omega} (\frac{\tilde{p}_{k+1} - \tilde{p}_k}{h} + d_y(x,T - \tau_{k}, \tilde{y}_k, \tilde{v}_k) \tilde{p}_{k+1} - \varphi_y(x,T - \tau_k,\tilde{y}_k, \tilde{v}_k)) v + \alpha \nabla \tilde{p}_{k+1} \nabla v dx & \\
+ \int_{\Gamma} (\alpha b_y(x,T-\tau_k, \tilde{y}_k, \tilde{u}) \tilde{p}_{k+1} - \psi_y(x,T-\tau_k, \tilde{y}_k, \tilde{u}_k) ) v \; ds  & = 0
\end{align*}
After the modified adjoint system was solved we get the original adjoint by substituting back $p(x,t_k) = \tilde{p}(x,\tau_k)$.

\subsection{Adjoint equation for our case}
In our case the equation simplifies to:
\begin{align*}
\int_{\Omega} (\frac{\tilde{p}_{k+1} - \tilde{p}_k}{h} - (\tilde{y}_k - \tilde{y}_{\Omega,k})) v + \alpha \nabla \tilde{p}_{k+1} \nabla v \; dx 
+ \int_{\Gamma} \frac{\alpha \gamma}{\beta} \tilde{p}_{k+1} v \; ds  = 0
\end{align*}

Additionally, we have the initial condition:
\begin{alignat*}{2}
\tilde{p}_{0} &= &\phi_y(x, \tilde{y}(x,0)) = y_{N} - y_{\Omega, N}
\end{alignat*}

Rewriting (without the time substitution for $y$) and inserting the different boundaries $\Gamma_{out}$ and $\Gamma_c$:
\begin{alignat*}{3}
&&\int_{\Omega} (\frac{\tilde{p}_{k+1} - \tilde{p}_k}{h} - (y_{N-k} - y_{\Omega,N-k})) v + \alpha \nabla \tilde{p}_{k+1} \nabla v \; dx && \\
&&+ \alpha \int_{\Gamma_{out}} \frac{\gamma_{out}}{\beta} \tilde{p}_{k+1} v \; ds + \alpha \int_{\Gamma_{c}} \frac{\gamma_{c}}{\beta} \tilde{p}_{k+1} v \; ds  = 0, && \\
&& && \text{ for } k \in \{0, \hdots, N-1\}.
\end{alignat*}

\section{Solution by Projected Gradient Method}
Let $N \in \mathbb{N}$ be the MPC horizon and let $u^n := (u_0^n, u_1^n, \hdots, u_{N-1}^n)$, $v^n := (v_0^n, v_1^n, \hdots, v_{N-1}^n)$ be the iterates of the optimization algorithm. \\ 
The gradient of the reduced cost functional $f(v,u) = J(y(v,u), v, u)$ is given by
\begin{align*}
f'(v^n, u^n)(v,u) = & \int \int_Q (\varphi_v(x,t, y^n, v^n) - d_v(x,t,y^n,v^n) p^n) \; v \; dx \; dt \\
& + \int \int_{\Sigma} (\psi_u(x,t,y^n, u^n) - b_u(x,t,y^n,u^n) p^n) \; u \; ds \; dt
\end{align*}
This can also be found in [Tr\"oltzsch, p. 243f], for the special case of $d(x,t,y,v) = v$, $b(x,t,y,u) = u$.

Solution algorithm:\\
\begin{enumerate}
\item Solve forward system for given $(u^n, v^n)$ $\rightsquigarrow y_n$ \\
\item Solve adjoint system $\rightsquigarrow p^n$ \\
\item Descent directions
\begin{align*}
&h^n := -(\varphi_v(\cdot, y^n, v^n) - d_v(\cdot,y^n,v^n) p^n) \\ 
&r^n := -(\psi_u(\cdot, y^n |_{\Sigma}, u^n) - b_u(\cdot,y^n,u^n) p^n |_{\Sigma})
\end{align*}
\item Compute step size $\rightsquigarrow s^n$
(e.g. use $\min_{s > 0} f(\mathbb{P}_V(v^n+s h^n), \mathbb{P}_U(u^n + s r^n)).$
\item New iterates:
\begin{equation}
(v^{n+1}, u^{n+1}) := (\mathbb{P}_V(v^n + s^n h^n), \mathbb{P}_U(u^n + s^n r^n))
\end{equation}
\end{enumerate}

\subsection{Gradient in our case}
\begin{align*}
f'(v^n, u^n)(v,u) = & \int \int_Q (\sigma v^n) \; v \; dx \; dt \\
& + \int \int_{\Sigma} (\lambda u^n) + \frac{\gamma}{\beta} p^n) \; u \; ds \; dt
\end{align*}

\section{Solver Options/Preconditioning}
\newpage
%----------------------------------------------------------------------------------------
%	BIBLIOGRAPHY
%----------------------------------------------------------------------------------------

\renewcommand{\refname}{Reference} % Change the default bibliography title

\bibliography{../bibtex} % Input your bibliography file
\bibliographystyle{plain}


%----------------------------------------------------------------------------------------

\end{document}
